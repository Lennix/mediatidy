#!/usr/bin/env coffee

program = require 'commander'
Config = require '../lib/config'
Movies = require '../lib/movies'
colors = require 'colors'
async = require 'async'

program.option('-a, --apiurl <apiurl>', 'API base URL')
  .option('-c, --clientid <clientid>', 'OAuth2 Client ID')
  .option('-s, --clientsecret <clientsecret>', 'OAuth2 Client secret')
  .option('-j, --json', 'display results in JSON')

program.command('update')
  .description('look for for files and directories and add to mediatidy database')
  .action () ->
    movie = new Movies Config.get('path')

    results = {}
    async.series [
      (callback) ->
        movie.update (videoFiles, otherFiles, dirs) ->
          results.videoFiles = videoFiles
          results.otherFiles = otherFiles
          results.dirs = dirs
          callback()
      (callback) ->
        movie.dbUpdate results.videoFiles, results.otherFiles, results.dirs, ->
          callback()
      (callback) ->
        movie.dbExists ->
          callback()
      (callback) ->
        movie.dbFileMetaUpdate ->
          callback()
      (callback) ->
        movie.dbFileSignature ->
          callback()
      (callback) ->
        movie.dbRead (files) ->
          callback()
    # optional callback
    ], (err, results) ->
      # console.log 'Results:', results

program.parse process.argv

program.help() if program.args.length is 0
